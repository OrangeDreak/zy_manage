import{r as L,a as r,l as N,m as B,w as a,f as s,h as g,e as l,d as v,k as y,t as _,E as P,ac as E,o as j,ad as J,p as R,c as S,ae as K,af as O,M as Q,F as G,n as X}from"./index-CRB7mnJR.js";import{_ as q}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Y=e=>L({url:"/admin/ticket/list",method:"post",data:e}),Z=e=>L({url:"/admin/ticket/completed",method:"post",data:e}),x=e=>L({url:"/admin/ticket/reply",method:"post",data:e}),ee=e=>L({url:"/admin/ticket/records?ticketId="+e,method:"get"}),te={class:"dialog-footer"},le={__name:"TicketForm",props:{modelValue:{type:Boolean,default:!1}},emits:["update:modelValue","submit"],setup(e,{emit:i}){const b=e,V=i,w=r(null),h=r(!1),c=r({title:"",content:""}),m=r(!1);N(()=>b.modelValue,o=>{m.value=o,c.value={}}),N(()=>m.value,o=>{V("update:modelValue",o)});const F={title:[{required:!0,message:"请输入标题",trigger:"blur"}]},d=async()=>{w.value&&await w.value.validate(async o=>{if(o){h.value=!0;try{console.log(c.value);const n=c.value;V("submit",c.value),P.success("success"),m.value=!1}catch(n){P.error(n)}finally{h.value=!1}}})};return(o,n)=>{const $=s("el-input"),k=s("el-form-item"),D=s("el-form"),C=s("el-button"),I=s("el-dialog");return g(),B(I,{modelValue:m.value,"onUpdate:modelValue":n[3]||(n[3]=t=>m.value=t),title:o.$t("ticket.ticketForm.title"),width:"800px","close-on-click-modal":!1},{footer:a(()=>[v("span",te,[l(C,{onClick:n[2]||(n[2]=t=>m.value=!1)},{default:a(()=>[y(_(o.$t("global_cancel")),1)]),_:1}),l(C,{type:"primary",onClick:d,loading:h.value},{default:a(()=>[y(_(o.$t("gloabl_confirm")),1)]),_:1},8,["loading"])])]),default:a(()=>[l(D,{ref_key:"formRef",ref:w,model:c.value,rules:F,"label-width":"150px",class:"address-form"},{default:a(()=>[l(k,{label:o.$t("ticket.ticketForm.titleLabel"),prop:"title"},{default:a(()=>[l($,{modelValue:c.value.title,"onUpdate:modelValue":n[0]||(n[0]=t=>c.value.title=t),placeholder:o.$t("ticket.ticketForm.titlePlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),l(k,{label:o.$t("ticket.ticketForm.contentLabel")},{default:a(()=>[l($,{modelValue:c.value.content,"onUpdate:modelValue":n[1]||(n[1]=t=>c.value.content=t),type:"textarea",rows:5,placeholder:o.$t("ticket.ticketForm.contentPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"])}}},ae=q(le,[["__scopeId","data-v-bcb783b6"]]),oe={class:"order-list-content"},ne={key:0},se={key:0,class:"message-other"},ie={key:0,class:"message-me"},ue={key:0},re={class:"dialog-footer"},de={__name:"TicketDetailForm",props:{modelValue:{type:Boolean,default:!1},ticketId:{type:Number,default:""},ticketStatus:{type:Number,default:""}},emits:["update:modelValue","submit"],setup(e,{emit:i}){const b=e,V=E({data:[]}),w=i,h=r(null),c=r(null),m=r(0),F=r(!1),d=r({content:""}),o=r(),n=r(!1);N(()=>b.modelValue,t=>{V.data=[],n.value=t,d.value={},b.ticketId&&(c.value=b.ticketId),m.value=b.ticketStatus,C()}),N(()=>n.value,t=>{w("update:modelValue",t)});const $={content:[{required:!0,message:"请输入内容",trigger:"blur"}]},k=async()=>{h.value&&await h.value.validate(async t=>{if(t)try{if(!d.value||!d.value.content)return;const u=d.value;u.ticketId=c.value,await x(u),d.value={},C()}catch(u){P.error(u)}})},D=async()=>{V.data=[],n.value=!1,w("submit",d.value)},C=async()=>{try{const t=await ee(c.value);V.data=t.data||[],setTimeout(()=>{I()},600)}catch(t){const u=t.message||"Get ticket detail fail";P.error(u)}finally{}},I=()=>{const t=o.value,u=t.$el.querySelector(".el-table__body");u&&(console.log(2),t.setScrollTop(u.scrollHeight))};return j(()=>{}),(t,u)=>{const U=s("el-avatar"),z=s("el-table-column"),M=s("el-table"),f=s("el-input"),T=s("el-form-item"),H=s("el-form"),A=s("el-button"),W=s("el-dialog");return g(),B(W,{modelValue:n.value,"onUpdate:modelValue":u[1]||(u[1]=p=>n.value=p),title:t.$t("ticket.ticketDetailForm.title"),width:"800px","close-on-click-modal":!1},J({default:a(()=>[v("div",oe,[l(M,{data:V.data,style:{width:"100%"},stripe:"","max-height":"500px","show-header":!1,ref_key:"tableRef",ref:o},{default:a(()=>[l(z,{width:"60"},{default:a(({row:p})=>[p.source===0?(g(),S("div",ne,[l(U,{style:{"background-color":"#f389d6"}},{default:a(()=>u[2]||(u[2]=[y(" User ")])),_:1})])):R("",!0)]),_:1}),l(z,{width:"320"},{default:a(({row:p})=>[p.source===0?(g(),S("div",se,[v("p",null,_(p.gmtCreate),1),v("p",null,_(p.content),1)])):R("",!0)]),_:1}),l(z,{width:"320"},{default:a(({row:p})=>[p.source===1?(g(),S("div",ie,[v("p",null,_(p.gmtCreate),1),v("p",null,_(p.content),1)])):R("",!0)]),_:1}),l(z,{width:"60"},{default:a(({row:p})=>[p.source===1?(g(),S("div",ue,[l(U,{style:{"background-color":"rgb(154 164 252)"}},{default:a(()=>u[3]||(u[3]=[y(" ME ")])),_:1})])):R("",!0)]),_:1})]),_:1},8,["data"])]),m.value!=2?(g(),B(H,{key:0,ref_key:"formRef",ref:h,model:d.value,rules:$,"label-width":"0px",class:"address-form"},{default:a(()=>[l(T,{label:t.$t("ticket.ticketDetailForm.contentLabel")},{default:a(()=>[l(f,{modelValue:d.value.content,"onUpdate:modelValue":u[0]||(u[0]=p=>d.value.content=p),type:"textarea",rows:3,placeholder:t.$t("ticket.ticketDetailForm.contentPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model"])):R("",!0)]),_:2},[m.value!==2?{name:"footer",fn:a(()=>[v("span",re,[l(A,{onClick:D},{default:a(()=>[y(_(t.$t("global_cancel")),1)]),_:1}),l(A,{type:"primary",onClick:k,loading:F.value},{default:a(()=>[y(_(t.$t("gloabl_confirm")),1)]),_:1},8,["loading"])])]),key:"0"}:void 0]),1032,["modelValue","title"])}}},ce=q(de,[["__scopeId","data-v-e98f3bd5"]]),me=K({name:"TicketList",components:{TicketForm:ae,TicketDetailForm:ce},setup(){const e=E({currentPage:1,pageSize:10}),i=E({keyword:"",status:null}),{proxy:b}=O(),V=Q(()=>[{status:0,label:b.$t("ticket.statusItem.submitted")},{status:1,label:b.$t("ticket.statusItem.processing")},{status:2,label:b.$t("ticket.statusItem.completed")}]),w=r(!1),h=r(!1),c=r(null),m=r(null),F=r([]),d=r(0),o=r(!1),n=r(null),$=r({}),k=async()=>{try{o.value=!0,n.value=null;let f={pageNo:e.currentPage,pageSize:e.pageSize,...i};const T=await Y(f);F.value=T.data,d.value=T.total}catch(f){n.value=f.message||"获取工单失败",P.error(n.value)}finally{o.value=!1}},D=()=>{e.currentPage=1,k()},C=f=>{e.pageSize=f,k()},I=f=>{e.currentPage=f,k()},t=()=>{k()},u=()=>{k()},U=()=>{$.value={},w.value=!0},z=f=>{h.value=!0,c.value=f.id,m.value=f.status},M=async f=>{try{o.value=!0,n.value=null;let T={id:f.id};await Z(T),k()}catch(T){n.value=T.message||"操作失败",P.error(n.value)}finally{o.value=!1}};return k(),{statusItems:V,searchForm:i,ticketList:F,total:d,pagination:e,formData:$,handleSizeChange:C,handleCurrentChange:I,handleSearch:D,handleAddTicket:U,ticketDialogVisible:w,ticketDetailDialogVisible:h,handleTicketSubmit:t,handleTicketDetailSubmit:u,handleView:z,handleCompleted:M,detailTicketId:c,detailTicketStatus:m}}}),pe={class:"order-list"},ke={class:"search-toolbar"},fe={class:"order-list-content"},ge={key:0},ve={key:1},_e={key:2},be={class:"pagination"},he={class:"total"};function ye(e,i,b,V,w,h){const c=s("el-input"),m=s("el-option"),F=s("el-select"),d=s("el-button"),o=s("el-table-column"),n=s("el-tag"),$=s("el-badge"),k=s("el-table"),D=s("el-pagination"),C=s("TicketForm"),I=s("TicketDetailForm");return g(),S(G,null,[v("div",pe,[v("div",ke,[l(c,{modelValue:e.searchForm.keyword,"onUpdate:modelValue":i[0]||(i[0]=t=>e.searchForm.keyword=t),placeholder:e.$t("ticket.keywordPlaceholder"),class:"search-input"},null,8,["modelValue","placeholder"]),l(F,{placeholder:e.$t("ticket.statusPlaceholder"),modelValue:e.searchForm.status,"onUpdate:modelValue":i[1]||(i[1]=t=>e.searchForm.status=t),style:{width:"30%"}},{default:a(()=>[(g(!0),S(G,null,X(e.statusItems,t=>(g(),B(m,{key:t.status,label:t.label,value:t.status},null,8,["label","value"]))),128))]),_:1},8,["placeholder","modelValue"]),l(d,{onClick:e.handleSearch},{default:a(()=>i[6]||(i[6]=[y("搜索")])),_:1},8,["onClick"])]),v("div",fe,[l(k,{data:e.ticketList,style:{width:"100%"},stripe:"",onRowDblclick:e.handleView,"highlight-current-row":!0},{default:a(()=>[l(o,{prop:"title",label:e.$t("ticket.title"),width:"500"},null,8,["label"]),l(o,{prop:"gmtCreate",label:e.创建时间},null,8,["label"]),l(o,{label:e.$t("ticket.status")},{default:a(({row:t})=>[l(n,null,{default:a(()=>[y(_(t.statusDesc),1)]),_:2},1024)]),_:1},8,["label"]),l(o,{label:e.操作,width:"150"},{default:a(t=>[t.row.unReadMsgNum?(g(),S("div",ge,[l($,{value:t.row.unReadMsgNum,class:"unReadMsgNum"},{default:a(()=>[l(d,{type:"text",onClick:u=>e.handleView(t.row)},{default:a(()=>[y(_(e.$t("ticket.view")),1)]),_:2},1032,["onClick"])]),_:2},1032,["value"])])):(g(),S("div",ve,[l(d,{type:"text",onClick:u=>e.handleView(t.row)},{default:a(()=>[y(_(e.$t("ticket.view")),1)]),_:2},1032,["onClick"])])),t.row.status!==2?(g(),S("div",_e,[l(d,{type:"text",onClick:u=>e.handleCompleted(t.row)},{default:a(()=>i[7]||(i[7]=[y("完结")])),_:2},1032,["onClick"])])):R("",!0)]),_:1},8,["label"])]),_:1},8,["data","onRowDblclick"])]),v("div",be,[v("div",he,"共 "+_(e.total)+" 条",1),l(D,{"current-page":e.pagination.currentPage,"onUpdate:currentPage":i[2]||(i[2]=t=>e.pagination.currentPage=t),"page-size":e.pagination.pageSize,"onUpdate:pageSize":i[3]||(i[3]=t=>e.pagination.pageSize=t),"page-sizes":[10,20,50],total:e.total,layout:"prev, pager, next, sizes",onSizeChange:e.handleSizeChange,onCurrentChange:e.handleCurrentChange},null,8,["current-page","page-size","total","onSizeChange","onCurrentChange"])])]),l(C,{modelValue:e.ticketDialogVisible,"onUpdate:modelValue":i[4]||(i[4]=t=>e.ticketDialogVisible=t),onSubmit:e.handleTicketSubmit},null,8,["modelValue","onSubmit"]),l(I,{modelValue:e.ticketDetailDialogVisible,"onUpdate:modelValue":i[5]||(i[5]=t=>e.ticketDetailDialogVisible=t),ticketId:e.detailTicketId,ticketStatus:e.detailTicketStatus,onSubmit:e.handleTicketDetailSubmit},null,8,["modelValue","ticketId","ticketStatus","onSubmit"])],64)}const $e=q(me,[["render",ye],["__scopeId","data-v-fd3216e8"]]);export{$e as default};
